<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Mar 22, 2012 ( $Revision: 1080083 $ ) -->
<!-- $HeadURL: https://svn.apache.org/repos/asf/commons/proper/commons-skin/trunk/src/main/resources/META-INF/maven/site.vm $ -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>
    Aggregator</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
      <meta name="author" content="Aggregator" />
    <meta name="Date-Revision-yyyymmdd" content="20120322" />
    <meta http-equiv="Content-Language" content="en" />
                                                    
<link rel="stylesheet" type="text/css" media="all" href="./css/prettify.css"/>                                                        
<script src="./js/prettify.js" type="text/javascript"></script>                                                        
<script type="text/javascript">window.onload=function() {
            prettyPrint();
        }</script>                      
        </head>
  <body class="composite">
    <div id="banner">
            <div id="bannerLeft">
                                            <a href="http://commons.apache.org/" title="Apache Commons logo">
                                        <img src="./images/commons-logo.png" alt="Apache Commons logo"/>
                </a>
            </div><!-- id="bannerLeft" -->
              <div id="bannerRight">
                                                          <a href="index.html">
                                                <img src="images/functor-logo-white.png" alt="Commons Functor"/>
                </a>
            </div><!-- id="bannerRight" -->
        <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                
                <div class="xleft">
        <span id="publishDate">Last Published: 22 March 2012</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="http://www.apachecon.com/" class="externalLink" title="ApacheCon">ApacheCon</a>
            |
                        <a href="http://www.apache.org" class="externalLink" title="Apache">Apache</a>
            |
                        <a href="../" title="Commons">Commons</a>
              
                
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                
                                <h5>Commons Functor</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="examples.html" title="Examples">Examples</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
                  <li class="none">
                          <a href="download_functor.cgi" title="Downloads">Downloads</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                                                              <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                       <h5>Commons</h5>
                  <ul>
                  <li class="none">
                          <a href="../" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/" class="externalLink" title="License">License</a>
            </li>
                                                                    <li class="collapsed">
                          <a href="../components.html" title="Components">Components</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../sandbox/index.html" title="Sandbox">Sandbox</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="../dormant/index.html" title="Dormant">Dormant</a>
                  </li>
          </ul>
                       <h5>General Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../volunteering.html" title="Volunteering">Volunteering</a>
            </li>
                  <li class="none">
                          <a href="../patches.html" title="Contributing Patches">Contributing Patches</a>
            </li>
                  <li class="none">
                          <a href="../building.html" title="Building Components">Building Components</a>
            </li>
                  <li class="none">
                          <a href="../releases/index.html" title="Releasing Components">Releasing Components</a>
            </li>
                  <li class="none">
                          <a href="http://wiki.apache.org/commons/FrontPage" class="externalLink" title="Wiki">Wiki</a>
            </li>
          </ul>
                       <h5>ASF</h5>
                  <ul>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works">How the ASF works</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/getinvolved.html" class="externalLink" title="Get Involved">Get Involved</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/dev/" class="externalLink" title="Developer Resources">Developer Resources</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
          </ul>
                                                                                                                   <a href="http://www.apache.org/events/current-event.html" title="ApacheCon" class="poweredBy">
        <img class="poweredBy"  alt="ApacheCon" src="http://www.apache.org/events/current-event-125x125.png"    />
      </a>
                                                                                                    <a href="http://maven.apache.org/" title="Maven" class="poweredBy">
        <img class="poweredBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"    />
      </a>
                       
                
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->
  

    <div class="section"><h2>Overview<a name="Overview"></a></h2>
      <p>
        The <a href="apidocs/org/apache/commons/functor/aggregate/package-summary.html">aggregator package</a> 
        provides a component which can be &quot;fed&quot; data from various sources and apply various 
        computations to this data to &quot;aggregate&quot; it. The design allows for a pluggable 
        implementation to be used for the purpose of aggregation and also provides flexibility
        with regards to storing the data being fed to this component.
        <br />
        There are 2 implementations as far as storage is concerned : <i>nostore</i> and 
        <tt>List</tt>-backed store. The former should be used when the aggregation 
        formula is simple enough to be applied on-the-fly without having to traverse a series 
        of data -- e.g. summarizing / adding the data -- while the latter can perform more advanced processing -- e.g.
        statistical calculations: median, average, percentile etc.
      </p>
    </div>  
    
    <div class="section"><h2>Storage<a name="Storage"></a></h2>
      <p>The <tt>List</tt>-backed store implementation stores the whole data series in a
      growing <tt>List</tt> such that when data is aggregated one can traverse the
      series and apply complex formulas (find the <a class="externalLink" href="http://en.wikipedia.org/wiki/Median" target="_blank">median</a> of a set of numeric values for instance).
      <br />
      The framework allows for any <tt>List</tt>-based implementation to be plugged in, by
      implementing <a href="apidocs/org/apache/commons/functor/aggregate/AbstractListBackedAggregator.html#createList">createList()</a>,
      however, there is also an <tt>ArrayList</tt>-based implementation provided in 
      <a href="apidocs/org/apache/commons/functor/aggregate/ArrayListBackedAggregator.html">ArrayListBackedAggregator</a>
      which can be used out-of-the-box.
      </p>
      
      <p>While the <i>store</i> implementation stores the data in a list, the <i>nostore</i> one
      stores just a single object -- every time data is fed into the <tt>Aggregator</tt>, 
      the data stored in this object and the data 
      <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#addT">passed in</a> 
      are &quot;aggregated&quot; there and then using the supplied 
      <a href="apidocs/org/apache/commons/functor/BinaryFunction.html">formula</a> and the result of this operation
      is stored back in the object this implementation uses to store data.
      <br />
      This has the implication that unlike the list-backed storage implementation (where the
      result of aggregating the data is not known until <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#evaluate">evaluate()</a>
      is called), with the <i>nostore</i> implementation the result is known (and saved back) at
      any moment. This arguably makes this class &quot;faster&quot;, however this comes at the cost of a
      slower <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#addT">add()</a>
      operation, as the aggregation formula is applied. Also, let's remind ourselves that not all
      formulas can be implemented using the <i>nostore</i> implementation (see above).
      </p>
    </div>
    
    <div class="section"><h2>Flushing Data<a name="Flushing_Data"></a></h2>
      <p>
      	The data an aggregator handles can be &quot;reset&quot; at any point -- in the case of the
      	<i>store</i> implementation this means emptying the <tt>List</tt>; in the case
      	of <i>nostore</i> this means setting the &quot;start value&quot; to a &quot;neutral&quot; value -- for
      	instance 0 for implementations which involve additions (<tt>Y + 0 = Y</tt>), 1 for 
      	multiplication (<tt>Y * 1 = Y</tt>) etc. This operation ultimately resets the
      	aggregator to the initial state it was in when created in the first place. This feature 
      	allows for a caller to schedule regular resets to free up resources etc.
      </p>
    </div>
    
    <div class="section"><h2>Timers<a name="Timers"></a></h2>
      <p>
      	Retrieving the data and regular intervals then flush/reset the aggregator was an
      	envisaged scenario for the aggregator -- so the base class 
      	<a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html">AbstractTimedAggregator</a>
      	offers support to start a timer internally to do that. The class offers a <i>listener</i> 
      	mechanism where classes can register to receive <a href="apidocs/org/apache/commons/functor/aggregate/TimedAggregatorListener">timer notifications</a> (if timer support was configured) and after all listeners have been 
      	notified the aggregator is <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#reset">reset</a>.
      	The result of 
      	<a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#evaluate">evaluate()</a>
      	(the result of aggregating data) is passed in to the listeners. This allows for an object 
      	to simply register itself as a timer listener to the aggregator and only react to the
      	timer notifications (e.g. write the result to a file for offline analysis etc) while the
      	aggregator itself manages all the internals.
      </p>
      
      <p>
        When the data is being flushed/reset, a 
        <a href="apidocs/org/apache/commons/functor/aggregate/TimedAggregatorListener.html">TimedAggregatorListener</a>
        can be registered to receive a notification. The notification is sent <b>after</b> the data is reset.
        Prior to resetting the data, <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#evaluate">evaluate()</a>
        is called, and the result of the evaluation is sent to the listener.<br />
        This allows for data aggregated periodically to be processed (e.g. logged, written into a database etc) without
        worrying about what happens in between.
      </p>
      
      <p>
      	There are 2 ways the 
      	<a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html">AbstractTimedAggregator</a> 
      	can be configured with timer support:
      </p>
      	<ul>
      		<li><b>Using a per-instance timer</b> : by default, when using the 
      		<a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html#AbstractTimedAggregatorlong">1
      		parameter constructor</a> with a value &gt; 0, the aggregator will create a 
      		<tt>Timer</tt> object internally and schedule the regular task of resetting the 
      		aggregator under this <tt>Timer</tt>. While this helps preventing memory leaks 
      		(both <tt>Aggregator</tt> and <tt>Timer</tt> will be recycled together) it
      		does increase the threading level in the system with each aggregator object created.
      		If your system creates a lot of <tt>AbstractTimedAggregator</tt> instances with
      		timer support, you might want to consider using the shared timer (see below).</li>
      		<li><b>Using a shared timer</b> : the <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html">AbstractTimedAggregator</a>
      		class creates a <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html#MAIN_TIMER">static 
      		timer instance</a> which can be shared amongst all instances of this class, if using 
      		<a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html#AbstractTimedAggregatorlong_boolean">the 
      		constructor with 2 params</a>. When doing so, each such instance will schedule its
      		regular reset task against this timer. While this reduces the memory footprint and
      		threading on the system, it can lead to memory leaks if this is not handled correctly.
      		Therefore please make sure you invoke <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html#stop">stop()</a>
      		on such aggregators when finished working with them.</li>
      	</ul>
      <p>
		It is recommended you always invoke <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html#stop">stop()</a>
      	at the end of the lifecycle of an aggregator -- regardless of timer support (shared / 
      	per instance) or not -- in particular calling <tt>stop()</tt> on an aggregator with
      	no timer support has no effect, however doing so ensures code uniformity and cleanliness.
      </p>
    </div>
    
    <div class="section"><h2>Examples<a name="Examples"></a></h2>
      <p>An example of usage for this component (though not necessarily the only one) could be in
      a highly transactional system where, for instance, the average transaction time can be an
      indication of the system health. While a fully-fledged monitoring system can say monitor
      the system load, file system etc., you might also want your monitoring system to keep an
      eye on the average transaction time. One way to do so is have an <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html">AbstractTimedAggregator</a> 
      which is capturing each transaction execution time and every say 5 seconds it computes
      the arithmetic mean (average) and writes that to a log file (which then your monitoring
      system can tail). To do so you would use a piece of code like this:
      </p>
      
      <div class="source"><pre>
public class AggregatorTesting implements TimedAggregatorListener&lt;Double&gt; {
    Aggregator&lt;Double&gt; agg;

    public AggregatorTesting() {
        AbstractTimedAggregator&lt;Double&gt; aggregator = new ArrayListBackedAggregator&lt;Double&gt;(new DoubleMeanValueAggregatorFunction(),
                5000L);
        aggregator.addTimerListener(this);
        this.agg = aggregator;
    }

    @Override
    public void onTimer(AbstractTimedAggregator&lt;Double&gt; aggregator) {
        double aggregated = aggregator.evaluate();
        /* log the value etc. */
    }

    private void add(double d) {
        agg.add(d);
    }

    public static void main(String[] args) {
        AggregatorTesting t = new AggregatorTesting();
        /* add data */
        t.add( 1.0 );
        t.add( 2.0 );
        /* .. */
    }
}      
      </pre></div>
      
      <p>Now let's assume that you occasionally see the odd spike in transaction times -- which,
      for the purpose of this example, we'll assume is normal. As such you are not concerned with
      these spikes, so you want a formula to exclude them. Chances are an arithmetic median
      would be more appropriate in this case; in which case the code above can suffer just a
      small change:
      </p>
      
      <div class="source"><pre>
      ...
        AbstractTimedAggregator&lt;Double&gt; aggregator = new ArrayListBackedAggregator&lt;Double&gt;(new DoubleMedianValueAggregatorFunction(),
                5000L);
       ...
      </pre></div>

      <p>Or maybe you want to be more precise and ensure that lets say 95% of your transactions
      take less than a certain execution time, so you replace the median formula with a 
      percentile one:
      </p>
      
      <div class="source"><pre>
      ...
        AbstractTimedAggregator&lt;Double&gt; aggregator = new ArrayListBackedAggregator&lt;Double&gt;(new DoublePercentileAggregatorFunction(95),
                5000L);
       ...
      </pre></div>
      
      <p>Or maybe your health indicator is the number of transactions going through the system
      every 5 seconds. In this case you can use a <i>nostore</i> aggregator with a sum formula 
      like this:
      </p>

      <div class="source"><pre>
public class AggregatorTesting implements TimedAggregatorListener&lt;Double&gt; {
    Aggregator&lt;Double&gt; agg;

    public AggregatorTesting() {
        AbstractTimedAggregator&lt;Double&gt; aggregator = new AbstractNoStoreAggregator&lt;Double&gt;(
                new DoubleSumAggregatorBinaryFunction(), 5000L) {
            @Override
            protected Double initialValue() {
                return 0.0;
            }
        };
        aggregator.addTimerListener(this);
        this.agg = aggregator;
    }

    @Override
    public void onTimer(AbstractTimedAggregator&lt;Double&gt; aggregator) {
        double aggregated = aggregator.evaluate();
        /* log the value etc. */
    }

    private void add(double d) {
        agg.add(d);
    }

    public static void main(String[] args) {
        AggregatorTesting t = new AggregatorTesting();
        /* add data */
        t.add(1.0);
        t.add(2.0);
        /* .. */
    }
}
      </pre></div>
      
      <p>(Bear in mind that there is also a 
      <a href="apidocs/org/apache/commons/functor/aggregate/functions/IntCountAggregatorBinaryFunction.html">IntCountAggregatorBinaryFunction</a> too!)
      </p>
      
      <p>This has the advantage of a lower memory footprint as well (see above). If your healthcheck
      indicator is based on the maximum transaction time over a 5 seconds interval, then you simply
      replace the <a href="apidocs/org/apache/commons/functor/aggregate/AbstractNoStoreAggregator.html#getAggregationFunction">aggregation 
      function</a> with a max value implementation:
      </p>
      
      <div class="source"><pre>
      ...
        AbstractTimedAggregator&lt;Double&gt; aggregator = new AbstractNoStoreAggregator&lt;Double&gt;(
                new DoubleMaxAggregatorBinaryFunction(), 5000L) {
      ...
      </pre></div>
      
	  <p>Or you can simply roll out your own code -- if using the <i>nostore</i> implementation,
	  all you need to do is implement a 
	  <a href="apidocs/org/apache/commons/functor/BinaryFunction.html">BinaryFunction</a> and pass
	  it to the <a href="apidocs/org/apache/commons/functor/aggregate/AbstractNoStoreAggregator.html#AbstractNoStoreAggregatororg.apache.commons.functor.BinaryFunction">Aggregator 
	  constructor</a>. This function will receive the already-stored
	  aggregated value as the first parameter, and data just passed in (via <a href="apidocs/org/apache/commons/functor/aggregate/Aggregator.html#addT">add()</a>) as the
	  second parameter; the result of this function will be stored back in the aggregator.
	  <br />
	  For the list-based aggregators, use an instance of 
	  <a href="apidocs/org/apache/commons/functor/aggregate/AbstractListBackedAggregator.html">AbstractListBackedAggregator</a> 
	  and pass in an instance of <a href="apidocs/org/apache/commons/functor/UnaryFunction.html">UnaryFunction</a>
	  which accepts a <tt>List</tt> and returns a single object.
	  <br />
	  Have a look at the 
	  <a href="apidocs/org/apache/commons/functor/aggregate/functions/package-summary.html">org.apache.commons.functor.aggregate.functions 
	  package</a> which includes a set of functions to achieve various of these tasks already.
	  </p>
	  
	  <p><b>Note on class naming</b> : You will notice in the 
	  <a href="apidocs/org/apache/commons/functor/aggregate/functions/package-summary.html">org.apache.commons.functor.aggregate.functions 
	  package</a> there are functions with similar names -- e.g.
	  <a href="apidocs/org/apache/commons/functor/aggregate/functions/DoubleSumAggregatorFunction.html">DoubleSumAggregatorFunction</a> 
	  and <a href="apidocs/org/apache/commons/functor/aggregate/functions/DoubleSumAggregatorBinaryFunction.html">DoubleSumAggregatorBinaryFunction</a>. 
	  The naming convention is that if the function takes 2
	  parameters (i.e. it is an instance of <a href="apidocs/org/apache/commons/functor/BinaryFunction.html">BinaryFunction</a> then the
	  name of the class in this package will contain <tt>BinaryFunction</tt>, otherwise, if it is an instance
	  of <a href="apidocs/org/apache/commons/functor/UnaryFunction.html">UnaryFunction</a> then the
	  name will only contain <tt>Function</tt>.<br />
	  The reason behind it is that instances of <tt>BinaryFunction</tt> can be used with
	  <a href="apidocs/org/apache/commons/functor/aggregate/AbstractNoStoreAggregator.html">AbstractNoStoreAggregator</a> 
	  whereas the instances of <tt>UnaryFunction</tt> can be used
	  with <a href="apidocs/org/apache/commons/functor/aggregate/AbstractTimedAggregator.html">AbstractTimedAggregator</a>.
	  </p>
    </div>
  

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="center">Copyright &#169;                    2003-2012
                        <a href="http://www.apache.org/">The Apache Software Foundation</a>.
            All Rights Reserved.      
                
      </div>
                          
<div class="center">Apache Commons, Apache Commons Functor, Apache, the Apache feather logo, and the Apache Commons project logos are trademarks of The Apache Software Foundation.
      All other marks mentioned may be trademarks or registered trademarks of their respective owners.</div>
                <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
